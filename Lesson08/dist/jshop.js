!function(t){var e={};function o(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,o),s.l=!0,s.exports}o.m=t,o.c=e,o.d=function(t,e,i){o.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},o.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},o.t=function(t,e){if(1&e&&(t=o(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(o.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)o.d(i,s,function(e){return t[e]}.bind(null,s));return i},o.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return o.d(e,"a",e),e},o.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},o.p="",o(o.s=0)}([function(t,e,o){"use strict";o.r(e);var i=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"goods-list"},[t.isEmptyGoodsList?o("div",[o("br"),t._v("Не найдено товаров."),o("br"),o("br")]):o("div",t._l(t.goods,(function(e){return o("goods-item",{key:e.id_product,attrs:{good:e},on:{"add-good":t.addGood}})})),1)])};function s(t,e,o,i,s,r,n,a){var d,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=o,c._compiled=!0),i&&(c.functional=!0),r&&(c._scopeId="data-v-"+r),n?(d=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),s&&s.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(n)},c._ssrRegister=d):s&&(d=a?function(){s.call(this,this.$root.$options.shadowRoot)}:s),d)if(c.functional){c._injectStyles=d;var l=c.render;c.render=function(t,e){return d.call(e),l(t,e)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,d):[d]}return{exports:t,options:c}}i._withStripped=!0,Vue.component("goods-item",{props:["good"],template:'<div class="goods-item">\n            <img :src="good.img ? good.img : \'https://via.placeholder.com/150\'"\n                 :alt="good.product_name" :title="good.product_name">\n            <h3>{{ good.product_name }}</h3>\n            <p>Цена: <b>{{ good.price.toLocaleString(\'ru-RU\') }} ₽</b></p>\n            <button class="add-button" title="Добавить товар в корзину"\n                    @click="onClickAddGoodButton">Добавить</button>\n        </div>',methods:{onClickAddGoodButton(){this.$emit("add-good",this.good.id_product)}}});var r=s({props:["goods"],computed:{isEmptyGoodsList(){return!(this.goods.length>0)}},methods:{addGood(t){this.$emit("add-good",t)}}},i,[],!1,null,null,null);r.options.__file="modules/goods.vue";var n=r.exports,a=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"search-container"},[o("form",{attrs:{id:"search-form"},on:{submit:function(e){return e.preventDefault(),t.findGood(e)}}},[o("input",{directives:[{name:"model",rawName:"v-model.trim",value:t.name,expression:"name",modifiers:{trim:!0}}],attrs:{type:"text",id:"search-pattern"},domProps:{value:t.name},on:{input:function(e){e.target.composing||(t.name=e.target.value.trim())},blur:function(e){return t.$forceUpdate()}}}),t._v(" "),o("button",{attrs:{id:"search-button"}},[t._v("Искать")])])])};a._withStripped=!0;var d=s({props:["pattern"],data(){return{name:this.pattern}},methods:{findGood(){this.$emit("find-good",this.name)}}},a,[],!1,null,null,null);d.options.__file="modules/search.vue";var c=d.exports,l=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",{staticClass:"cart"},[o("h2",[t._v("Корзина:")]),o("hr"),t._v(" "),t.isEmptyCart?o("div",[o("br"),t._v("Не выбрано товаров."),o("br"),o("br")]):o("div",[t._l(t.goods,(function(t){return o("cart-item",{key:t.id,attrs:{good:t}})})),t._v(" "),o("hr"),o("div",{staticClass:"cart-cost"},[t._v("Итого: "+t._s(t.sum))])],2),o("hr"),t._v(" "),o("div",[o("button",{staticClass:"cart-button-red",attrs:{title:"Очистить корзину"},on:{click:t.removeAllGoods}},[t._v("х")]),t._v(" "),o("button",{staticClass:"cart-button",attrs:{title:"Оформить заказ"},on:{click:t.makeOrder}},[t._v("Оформить заказ")])]),t._v(" "),t._m(0)])};l._withStripped=!0,Vue.component("cart-item",{props:["good"],template:'<div class="cart-item">\n            <button class="cart-button" title="Увеличить кол-во товара в корзине"\n                    @click="addGood">+</button>\n            <button class="cart-button" title="Уменьшить кол-во товара в корзине"\n                    @click="decGood">-</button>\n            <button class="cart-button-red" title="Удалить товар из корзины"\n                    @click="removeGood">х</button>\n            <b>{{ good.name }}</b> - {{ good.n }} шт. * {{ good.price.toLocaleString(\'ru-RU\') }} ₽ = {{ (good.price * good.n).toLocaleString(\'ru-RU\') }}  ₽ \n        </div>',methods:{addGood(){this.$root.addGood(this.good.id)},decGood(){this.$root.decGood(this.good.id)},removeGood(){this.$root.removeGood(this.good.id)}}});var u=s({props:["goods","sum"],computed:{isEmptyCart(){return!(this.goods.length>0)}},methods:{getSum(){this.$root.getSum()},removeAllGoods(){for(let t of this.goods)this.$root.removeGood(t.id)},makeOrder(){alert("Не сейчас...")}}},l,[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"goods-list-ref"},[e("a",{attrs:{href:"index.html",title:"Продолжить выбор товаров"}},[this._v("« Вернуться к товарам")])])}],!1,null,null,null);u.options.__file="modules/cart.vue";var m=u.exports,h=function(){var t=this,e=t.$createElement,o=t._self._c||e;return o("div",[o("transition",{attrs:{name:"fade"}},[t.ismessage?o("div",{attrs:{id:"msg-box"},domProps:{innerHTML:t._s(t.msg)}}):t._e()]),t._v(" "),o("button",{staticClass:"log-button",attrs:{title:t.getLogButtonTitle},on:{click:t.switchLog}},[t._v("Лог")]),t._v(" "),o("button",{staticClass:"log-button-red",attrs:{title:"Очистить лог"},on:{click:t.clearLog}},[t._v("Очистка")]),t._v(" "),t.isVisibleLog?o("div",{staticClass:"log-list"},t._l(t.log,(function(t){return o("log-item",{attrs:{item:t}})})),1):t._e()],1)};h._withStripped=!0,Vue.component("log-item",{props:["item"],template:"<div class=\"log-item\">\n            [{{ new Date(item.datetime).toLocaleString('ru-RU') }}] {{ actionName(item.action) }} <b>{{ goodName(item.id) }}</b> (#{{ item.id }}) - <b>{{ item.n }}</b> шт.\n        </div>",methods:{actionName:t=>0===t?"добавление":"удаление",goodName(t){return this.$root.fetchGood(t).product_name}}});var g=s({props:["ismessage","msg","islog","log"],data(){return{isVisibleLog:this.islog}},computed:{getLogButtonTitle(){return this.isVisibleLog?"Скрыть лог":"Показать лог"}},methods:{async switchLog(){this.isVisibleLog=!this.isVisibleLog,this.isVisibleLog&&(this.$root.log=await this.$root.makeXHRequest("/log","GET"))},clearLog(){this.$root.makeXHRequest("/log","DELETE"),this.$root.log=[]}}},h,[],!1,null,null,null);g.options.__file="modules/log.vue";var p=g.exports;new Vue({el:"#app",data:{cart:[],goods:[],filteredGoods:[],cartSum:0,isMsgBox:!1,message:"",timeoutId:null,pattern:"",log:[],isVisibleLog:!1},components:{search:c,goods:n,cart:m,log:p},computed:{getSum(){return`${this.cartSum.toLocaleString("ru-RU")} ₽`},getImage:t=>(t.img||(t.img="https://via.placeholder.com/150"),t.img),isCartMode:()=>-1!==window.location.search.lastIndexOf("cart"),cartSize(){return this.cart.length},getCart(){const t=JSON.parse(JSON.stringify(this.cart));return t.forEach((e,o)=>{const i=this.fetchGood(e.id);t[o].price=i.price,t[o].name=i.product_name}),t}},methods:{makeXHRequest:(t,e,o=null)=>new Promise((i,s)=>{let r;r=window.XMLHttpRequest?new window.XMLHttpRequest:new window.ActiveXObject("Microsoft.XMLHTTP"),r.onreadystatechange=function(){4===r.readyState&&(200===r.status?i(JSON.parse(r.responseText)):s(r.responseText))},r.timeout=5e3,r.ontimeout=function(){s("Timeout")},r.onerror=function(t){s(t)},r.open(e,`http://localhost:3000/api${t}`),"POST"===e&&(r.setRequestHeader("Content-Type","application/json"),r.setRequestHeader("Charset","utf-8")),r.send(o)}),async fetchGoods(){try{this.goods=await this.makeXHRequest("/goods","GET"),this.filteredGoods=[...this.goods],this.cart=await this.makeXHRequest("/cart","GET"),this.sum()}catch(t){console.error(t)}},fetchGood(t){return this.goods.find(e=>e.id_product===t)},addGood(t){let e=this.cart.findIndex(e=>e.id===t);e<0?this.cart.push({id:t,n:1}):this.cart[e].n+=1;const o={action:0,id:t,n:1};this.update(o)},decGood(t){let e=this.cart.findIndex(e=>e.id===t);e>=0&&(this.cart[e].n-=1,0===this.cart[e].n&&this.removeGood(t));const o={action:1,id:t,n:1};this.update(o)},removeGood(t){const e=this.cart.findIndex(e=>e.id===t),o=this.cart[e].n;e>=0&&this.cart.splice(e,1);const i={action:1,id:t,n:o};this.update(i)},update(t){this.makeXHRequest("/cart","POST",JSON.stringify(this.cart)),this.sum(),this.showMsg(this.getMsg(t));const e=new Date;t.datetime=e,this.makeXHRequest("/log","POST",JSON.stringify(t)),this.log.push(t)},getMsg(t){let e="";switch(t.action){case 0:e="В корзину добавлен товар: ";break;case 1:e="Из корзины удалён товар: "}return""!==e&&(e=`${e} ${this.fetchGood(t.id).product_name} (#${t.id}) - ${t.n} шт.`),e},showMsg(t){""!==t&&(this.isMsgBox?(this.message+=`<br />${t}`,clearTimeout(this.timeoutId),this.isMsgBox=!1):this.message=t,this.isMsgBox=!0,this.timeoutId=setTimeout(()=>{this.isMsgBox=!1},3e3))},sum(){this.cartSum=0;for(let t of this.cart){let e=this.fetchGood(t.id);this.cartSum+=t.n*e.price}return this.cartSum},findGood(t){""===t?this.filteredGoods=[...this.goods]:this.filterGoods(t)},filterGoods(t){const e=new RegExp(t,"i");this.filteredGoods=this.goods.filter(o=>e.test(o.product_name,t))},intoCart(){document.location="index.html?cart"}},mounted(){this.fetchGoods()}})}]);